<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P WiFi File Sharer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .progress-bar-inner {
            transition: width 0.3s ease-in-out;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl">
        
        <!-- Initial View -->
        <div id="initial-view">
            <h1 class="text-2xl font-bold mb-6 text-center text-cyan-400">P2P File Sharer</h1>
            <div class="flex flex-col space-y-4">
                <button id="go-to-sender" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Send a File</button>
                <button id="go-to-receiver" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Receive a File</button>
            </div>
        </div>

        <!-- Sender View -->
        <div id="sender-view" class="hidden">
            <h1 class="text-2xl font-bold mb-2 text-center text-cyan-400">Share a File</h1>
            <p class="text-gray-400 mb-6 text-center">Select a file to generate a room name.</p>
            
            <div class="mb-6">
                <label for="file-input" class="w-full inline-block bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg text-center cursor-pointer transition-colors">
                    Select File
                </label>
                <input type="file" id="file-input" class="hidden">
            </div>

            <div id="room-name-container" class="hidden text-center mb-6 bg-gray-700 p-4 rounded-lg">
                <p class="text-sm text-gray-400 mb-2">Share this room name with the receiver:</p>
                <div class="flex justify-center items-center gap-2">
                    <p class="text-2xl font-bold text-white" id="room-name"></p>
                    <button id="copy-room-name" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                          <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                        </svg>
                    </button>
                </div>
            </div>
             
            <div id="status-sender" class="mt-4 text-center text-gray-400"></div>
            <button id="sender-start-over" class="hidden mt-4 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Start Over</button>
        </div>

        <!-- Receiver View -->
        <div id="receiver-view" class="hidden">
            <h1 class="text-2xl font-bold mb-2 text-center text-teal-400">Receive a File</h1>
            <p class="text-gray-400 mb-4 text-center">Enter the room name from the sender.</p>
            
            <div id="receiver-connect-form">
                <div class="flex gap-2">
                    <input type="text" id="room-name-input" placeholder="e.g. blue-river-42" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <button id="connect-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Connect</button>
                </div>
            </div>

            <div id="status-receiver" class="text-center font-medium mt-4"></div>
            
            <div id="progress-container" class="hidden w-full bg-gray-700 rounded-full h-4 my-4 overflow-hidden">
                <div id="progress-bar" class="bg-teal-500 h-4 rounded-full progress-bar-inner" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="text-center text-sm text-gray-400 mb-4"></div>

            <div id="download-link-container" class="hidden text-center">
                <a id="download-link" class="w-full inline-block bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg text-center cursor-pointer transition-colors">
                    Download File
                </a>
            </div>
            <button id="receiver-start-over" class="hidden mt-4 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Start Over</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Views
            const initialView = document.getElementById('initial-view');
            const senderView = document.getElementById('sender-view');
            const receiverView = document.getElementById('receiver-view');

            // Buttons
            const goToSenderBtn = document.getElementById('go-to-sender');
            const goToReceiverBtn = document.getElementById('go-to-receiver');
            const connectBtn = document.getElementById('connect-btn');
            const copyRoomNameBtn = document.getElementById('copy-room-name');
            const senderStartOverBtn = document.getElementById('sender-start-over');
            const receiverStartOverBtn = document.getElementById('receiver-start-over');

            // Senders Elements
            const fileInput = document.getElementById('file-input');
            const roomNameContainer = document.getElementById('room-name-container');
            const roomNameDisplay = document.getElementById('room-name');
            const statusSender = document.getElementById('status-sender');

            // Receiver Elements
            const roomNameInput = document.getElementById('room-name-input');
            const statusReceiver = document.getElementById('status-receiver');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const downloadLinkContainer = document.getElementById('download-link-container');
            const downloadLink = document.getElementById('download-link');
            const receiverConnectForm = document.getElementById('receiver-connect-form');

            let peer;
            let fileToSend;
            let currentConnection;

            // --- Navigation ---
            goToSenderBtn.addEventListener('click', () => {
                initialView.classList.add('hidden');
                senderView.classList.remove('hidden');
            });

            goToReceiverBtn.addEventListener('click', () => {
                initialView.classList.add('hidden');
                receiverView.classList.remove('hidden');
            });
            
            function resetToInitialView() {
                if (peer) {
                    peer.destroy();
                    peer = null;
                }
                if(currentConnection) {
                    currentConnection.close();
                    currentConnection = null;
                }

                // Reset sender view
                senderView.classList.add('hidden');
                fileInput.value = '';
                roomNameContainer.classList.add('hidden');
                statusSender.textContent = '';
                senderStartOverBtn.classList.add('hidden');
                
                // Reset receiver view
                receiverView.classList.add('hidden');
                roomNameInput.value = '';
                statusReceiver.textContent = '';
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = '';
                downloadLinkContainer.classList.add('hidden');
                receiverConnectForm.classList.remove('hidden');
                receiverStartOverBtn.classList.add('hidden');

                // Show initial view
                initialView.classList.remove('hidden');
            }

            senderStartOverBtn.addEventListener('click', resetToInitialView);
            receiverStartOverBtn.addEventListener('click', resetToInitialView);

            // --- PeerJS Logic ---
            function initializePeer(peerId) {
                if (peer) {
                    peer.destroy();
                }
                peer = new Peer(peerId, {
                    host: 'peerjs-server.herokuapp.com',
                    secure: true,
                    port: 443
                });

                peer.on('open', id => {
                    console.log('My peer ID is: ' + id);
                });

                peer.on('connection', conn => {
                    console.log('Peer connected');
                    currentConnection = conn;
                    statusSender.textContent = 'Peer connected. Sending file...';
                    conn.on('data', data => { /* Sender doesn't expect data */ });
                    if (fileToSend) {
                        sendFile(conn);
                    }
                });
                
                // FIX: Add handlers for disconnection and reconnection
                peer.on('disconnected', () => {
                    const msg = 'Connection to server lost. Attempting to reconnect...';
                    console.log(msg);
                    statusSender.textContent = msg;
                    statusReceiver.textContent = msg;
                    if (!peer.destroyed) {
                        // Use a timeout to prevent frantic reconnection attempts
                        setTimeout(() => peer.reconnect(), 3000);
                    }
                });

                peer.on('close', () => {
                    console.log('Peer connection has been closed.');
                    currentConnection = null;
                });
                
                peer.on('error', err => {
                    console.error('PeerJS error:', err);
                    // FIX: Provide more specific error messages
                    if (err.type === 'peer-unavailable') {
                        statusReceiver.textContent = 'Could not find peer. Please check the room name and that the sender is still active.';
                    } else if (err.type === 'network') {
                        statusSender.textContent = 'Network error. Please check your connection.';
                        statusReceiver.textContent = 'Network error. Please check your connection.';
                    } else {
                        statusSender.textContent = `Error: ${err.type}. Please try again.`;
                        statusReceiver.textContent = `Error: ${err.type}. Please try again.`;
                    }
                });
            }

            // --- Sender Logic ---
            fileInput.addEventListener('change', event => {
                const file = event.target.files[0];
                if (file) {
                    fileToSend = file;
                    const newRoomName = generateRoomName();
                    roomNameDisplay.textContent = newRoomName;
                    roomNameContainer.classList.remove('hidden');
                    senderStartOverBtn.classList.remove('hidden');
                    statusSender.textContent = 'Waiting for receiver...';
                    initializePeer(newRoomName);
                }
            });

            copyRoomNameBtn.addEventListener('click', () => {
                // Use a fallback for browsers that don't support navigator.clipboard in insecure contexts
                try {
                    navigator.clipboard.writeText(roomNameDisplay.textContent).then(() => {
                        alert('Room name copied to clipboard!');
                    });
                } catch (err) {
                    const textArea = document.createElement("textarea");
                    textArea.value = roomNameDisplay.textContent;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert('Room name copied to clipboard!');
                    } catch (err) {
                        console.error('Fallback copy failed: ', err);
                        alert('Could not copy room name.');
                    }
                    document.body.removeChild(textArea);
                }
            });

            function generateRoomName() {
                const adjectives = ['swift', 'silent', 'red', 'blue', 'green', 'happy', 'fast', 'bright', 'sharp', 'cold'];
                const nouns = ['river', 'mountain', 'sky', 'sea', 'forest', 'star', 'moon', 'sun', 'lake', 'meadow'];
                const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const noun = nouns[Math.floor(Math.random() * nouns.length)];
                const number = Math.floor(Math.random() * 90) + 10;
                return `${adj}-${noun}-${number}`;
            }

            function sendFile(conn) {
                const chunkSize = 64 * 1024; // 64KB chunks
                const reader = new FileReader();
                let offset = 0;
                
                const metadata = {
                    name: fileToSend.name,
                    size: fileToSend.size,
                    type: fileToSend.type
                };
                conn.send({ type: 'metadata', payload: metadata });

                reader.onload = function(e) {
                    if (!e.target.error) {
                        try {
                            conn.send({ type: 'chunk', payload: e.target.result });
                            offset += e.target.result.byteLength;
                            if (offset < fileToSend.size) {
                                readSlice(offset);
                            } else {
                               statusSender.textContent = 'File sent successfully!';
                            }
                        } catch (e) {
                            console.error("Failed to send chunk:", e);
                            statusSender.textContent = 'Connection lost during transfer. Please start over.';
                            resetToInitialView();
                        }
                    } else {
                        console.error('Error reading file:', e.target.error);
                        statusSender.textContent = 'Error reading file.';
                    }
                };

                function readSlice(o) {
                    const slice = fileToSend.slice(o, o + chunkSize);
                    reader.readAsArrayBuffer(slice);
                }
                
                readSlice(0);
            }

            // --- Receiver Logic ---
            connectBtn.addEventListener('click', () => {
                const roomName = roomNameInput.value.trim().toLowerCase();
                if (!roomName) {
                    statusReceiver.textContent = 'Please enter a room name.';
                    return;
                }
                
                statusReceiver.textContent = `Connecting to room: ${roomName}...`;
                
                initializePeer(); // Initialize with a random ID
                
                // Wait for peer to be ready before connecting
                const connectInterval = setInterval(() => {
                    if (peer && peer.open) {
                        clearInterval(connectInterval);
                        const conn = peer.connect(roomName);
                        currentConnection = conn;
                        conn.on('open', () => {
                             console.log('Connection opened with sender');
                             receiverConnectForm.classList.add('hidden');
                             receiverStartOverBtn.classList.remove('hidden');
                             statusReceiver.textContent = 'Connected. Waiting for file...';
                             conn.on('data', handleData);
                        });
                         conn.on('error', (err) => {
                            console.error('Connection error:', err);
                            statusReceiver.textContent = 'Failed to connect. Check the room name and try again.';
                        });
                    }
                }, 500);
            });

            let receivedFileParts = [];
            let fileMetadata = {};

            function handleData(data) {
                if (data.type === 'metadata') {
                    fileMetadata = data.payload;
                    receivedFileParts = [];
                    progressContainer.classList.remove('hidden');
                    statusReceiver.textContent = `Receiving: ${fileMetadata.name}`;
                    console.log('Receiving metadata:', fileMetadata);
                } else if (data.type === 'chunk') {
                    receivedFileParts.push(data.payload);
                    const receivedSize = receivedFileParts.reduce((acc, part) => acc + part.byteLength, 0);
                    const progress = (receivedSize / fileMetadata.size) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${Math.round(progress)}% - ${formatBytes(receivedSize)} / ${formatBytes(fileMetadata.size)}`;

                    if (receivedSize === fileMetadata.size) {
                        assembleAndDownloadFile();
                    }
                }
            }
            
            function assembleAndDownloadFile() {
                const fileBlob = new Blob(receivedFileParts, { type: fileMetadata.type });
                const url = URL.createObjectURL(fileBlob);
                downloadLink.href = url;
                downloadLink.download = fileMetadata.name;
                downloadLinkContainer.classList.remove('hidden');
                statusReceiver.textContent = 'File received successfully!';
                progressText.textContent = `Complete!`;
            }

            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>
